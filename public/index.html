<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */

.instructions-covered { fill: rgb(0, 107, 174); }

.mutants-killed { fill: rgb(0, 148, 255); }

.assertions-input { fill: rgb(255, 91, 1); }

.tests-input { fill: rgb(115, 197, 253); }

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}
</style>
<body>
	
<!-- load the d3.js library -->    	
<script src="//d3js.org/d3.v4.min.js"></script>
<script
src="https://code.jquery.com/jquery-3.2.1.min.js"
integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
crossorigin="anonymous"></script>
<script src="midi.js"></script>

<script src="d3tip.js"></script>


<script>

const ORIGINAL_TESTS = 8;

let fullCanvas = d3.select("body").append("svg")
                                    .attr("width", window.innerWidth)
                                    .attr("height", window.innerHeight);

const PADDING = 10;

//Input panel
const INPUT_AREA = { x: 0, y: window.innerHeight, height: 120, width: window.innerWidth };
INPUT_AREA.y -= INPUT_AREA.height - PADDING;

let inputPanel = fullCanvas.append("g")
                      .attr("transform", "translate(0, " + INPUT_AREA.y  + ")");

//Output chart
const CHART_AREA = { x: 0, y: 0, height: window.innerHeight - INPUT_AREA.height, width: window.innerWidth };

let barChart = fullCanvas.append("g");

//Positional scales
let xScale = d3.scaleBand()
                  .range([0, INPUT_AREA.width])
                  .paddingOuter(0.2)
                  .paddingInner(0.1)
                  .domain(d3.range(ORIGINAL_TESTS));

let xCenters = d3.scalePoint()
                    .range([
                      xScale(0) + xScale.bandwidth()/2, 
                      xScale(ORIGINAL_TESTS - 1) + xScale.bandwidth()/2])
                    .domain(d3.range(ORIGINAL_TESTS));


let yScale = d3.scaleLinear().range([CHART_AREA.height - PADDING, PADDING]);
let hScale = d3.scaleLinear().range([PADDING, CHART_AREA.height - PADDING]);

const ASSERTIONS_DOMAIN = d3.range(1, 6);
const TESTS_DOMAIN = d3.range(10, 60, 10);

const RADIUS = xScale.bandwidth() / 4;
let arc = d3.arc().innerRadius(RADIUS*0.7).outerRadius(RADIUS).startAngle(Math.PI);
let angle = d3.scaleLinear().domain([1,5]).range([4 * Math.PI / 3, 3*Math.PI]);

//Create visual elements
inputPanel.selectAll("rect.tests-input")
            .data(d3.range(ORIGINAL_TESTS))
          .enter()
          .append("rect")
            .attr("class", "tests-input")
            .attr("width", RADIUS)
            .attr("height", d => d)
            .attr("y", 2*RADIUS + PADDING)
            .attr("x", (d, i) => xScale(i) + RADIUS / 2);

inputPanel.selectAll("text.tests-input")
            .data(d3.range(ORIGINAL_TESTS))
            .enter()
            .append("text")
              .attr("class", "tests-input")
              .attr("font-family", "sans-serif")
              .attr("font-size", "25px")
              .attr("x", (d, i) => xScale(i) + 25)
              .attr("y", RADIUS + PADDING + 25);


inputPanel.selectAll("path.assertions-input")
            .data(d3.range(ORIGINAL_TESTS))
          .enter()
          .append("path")
            .attr("class", "assertions-input")
            .attr("d", (d, i) => arc({endAngle: angle(d)}))
            .attr("transform", (d,i) =>  "translate(" + (xCenters(i) + RADIUS) + "," +  RADIUS + ")");

inputPanel.selectAll("text.assertions-input")
            .data(d3.range(ORIGINAL_TESTS))
            .enter()
            .append("text")
              .attr("class", "assertions-input")
              .attr("font-family", "sans-serif")
              .attr("font-size", "30px")
              .attr("x", (d, i) => xCenters(i) + 30)
              .attr("y", RADIUS + 10);

 barChart.selectAll(".instructions-covered")
              .data(d3.range(ORIGINAL_TESTS))
            .enter()
            .append("rect")
              .attr("class", "instructions-covered")
              .attr("x", (d,i) => xScale(i))
              .attr("y", d => yScale(0))
              .attr("width", d => xScale.bandwidth() / 2);

barChart.selectAll(".mutants-killed")
            .data(d3.range(ORIGINAL_TESTS))
          .enter()
          .append("rect")
            .attr("class", "mutants-killed")
            .attr("x", (d, i) => xCenters(i))
            .attr("y", d => yScale(0))
            .attr("width", d => xScale.bandwidth() / 2);



$.ajax({ url: "/midi/0/0", method: "GET" }).then(function(data) {

  // format the data
  data.forEach(function(d) {
    d.value = +d.value;
  });
  
  yScale.domain([0, d3.max(data, function(d) { return d.value; })]); //TODO: Check whether this can be computed
  hScale.domain([0, d3.max(data, function(d) { return d.value; })]);

  updateChart(data);
  updateInputPanel();

  // Scale the range of the data in the domains
  // x.domain(data.map(function(d) { return d.name; }));
  // y.domain([0, d3.max(data, function(d) { return d.value; })]);

  // var tip = d3.tip()
  // .attr('class', 'd3-tip')
  // .offset([-10, 0])
  // .html(function(d) {
  //   return "<strong>Test added:</strong> <span style='color:red'>" + d.testadded + "</span><BR><strong>Assert added:</strong> <span style='color:red'>" + d.assertadded + "</span>";
  // })

  // svg.call(tip);


  // append the rectangles for the bar chart
  // svg.selectAll(".bar")
  //     .data(data)
  //   .enter().append("rect")
  //     .attr("class", "bar")
  //     .attr("x", function(d) { return x(d.name); })
  //     .attr("width", x.bandwidth())
  //     .attr("y", function(d) { return y(d.value); })
  //     .attr("height", function(d) { return height - y(d.value); })
  //     .attr("fill",function(d,i){return colors[i%2]})
  //           .on('mouseover', tip.show)
  //     .on('mouseout', tip.hide)
  //     ;

      // svg.selectAll("text.bar")
      //   .data(data)
      // .enter().append("text")
      //   .attr("class", "bar")
      //   .attr("class", "foo1")
      //   .attr("text-anchor", "middle")
      //   .attr("x", function(d) { return x(d.name) + 40; })
      //   .attr("y", function(d) { return y(d.value) - 10; })
      //   .style("font-size","18px")
      //   .text(function(d) { return '('+d.testadded+')('+d.assertadded+')' });


  // // add the x Axis
  // svg.append("g")
  //     .attr("transform", "translate(0," + height + ")")
  //     .call(d3.axisBottom(x))
  //     .selectAll("text")	
  //       .style("text-anchor", "end")
  //       .attr("transform", "rotate(-75)")
  //       .attr("dx", "-.8em")
  //       .attr("x", "-10px")
  //       .attr("dy", "1.7em")
  //       .style("font-size","15px");
  //     ;



  // // add the y Axis
  // svg.append("g")
  //     .call(d3.axisLeft(y));
      
    
});


function requestData(note, velocity) {
  $.ajax( {url: "/midi/" + note + '/' + velocity, method: "GET" })
        .then(updateChart);
}

function updateChart(data) {
  let mutantsKilled = data.filter((e, i) => i % 2 == 0);
  let instructionCovered = data.filter((e, i) => i % 2 == 1);

  barChart.selectAll(".mutants-killed")
            .data(mutantsKilled)
          .transition()
            .duration(1000)
            .attr("y", d => yScale(d.value))
            .attr("height", d => hScale(d.value));

  barChart.selectAll(".instructions-covered")
            .data(instructionCovered)
          .transition()
            .duration(1000)
            .attr("y", d => yScale(d.value))
            .attr("height", d => hScale(d.value));
}

let assertionsScale = d3.scaleQuantize().domain([0, 127]).range(ASSERTIONS_DOMAIN);
let testsScale = d3.scaleQuantize().domain([0, 127]).range(TESTS_DOMAIN);

const INPUT_VALUES = d3.range(ORIGINAL_TESTS).map(x =>{ return {index: x, assertions: 1, tests: 10}; });

function translateMIDIMessage(note, velocity) {
  if( note >= 0 && note <= 7) {
    return {
      index: note, 
      tests: testsScale(velocity),
      assertions: INPUT_VALUES[note].assertions
    };
  }
  else if (note >= 16 && note <= 23) {
    return {
      index: note - 16, 
      assertions: assertionsScale(velocity),
      tests: INPUT_VALUES[note - 16].tests
    }
  }
  return null;
}

function updateInputPanel(input) {
  if(input)
    INPUT_VALUES[input.index] = input;

  let assertions = INPUT_VALUES.map(x => x.assertions);
  let tests = INPUT_VALUES.map(x => x.tests);

  inputPanel.selectAll("path.assertions-input")
              .data(assertions)
              .attr('d', (d, i) => arc({endAngle: angle(d)}));

  inputPanel.selectAll("text.assertions-input").data(assertions).text(d => d);
  
  inputPanel.selectAll("rect.tests-input")
              .data(tests)
              .attr("height", d => d)
              .attr("y", d => RADIUS + PADDING - d);
  
  inputPanel.selectAll("text.tests-input").data(tests).text(d => d);
}

function onInput(command, note, velocity) {
  let input = translateMIDIMessage(note, velocity);
  if(!input) {
    return; //Ignore messages from other buttons
  }
  updateInputPanel(input);
  requestData(note, velocity); //TODO: Change to input object
}

//Device input
NanoKontrolInput.error.register((error) => { console.error(error.message); });
NanoKontrolInput.message.register(onInput);
NanoKontrolInput.connect();

</script>
</body>